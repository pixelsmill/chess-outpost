<div class="layout-with-sidebar">
  <!-- Nouveau panneau de gauche -->
  <div class="side-panel left-panel">
    <div class="panel-content">
      <div class="sidebar-body">
        <!-- Sécurité du roi -->
        <div class="analysis-section">
          <h3
            (click)="toggleSection('kingSafety')"
            [class.expanded]="isSectionExpanded('kingSafety')"
          >
            Sécurité du roi
            <span class="expand-icon">{{
              isSectionExpanded("kingSafety") ? "▼" : "▶"
            }}</span>
          </h3>
          <div
            class="indicator-list"
            [class.expanded]="isSectionExpanded('kingSafety')"
          >
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.attackersVsDefenders || 0)
              "
            >
              <span class="indicator-title"
                >Attaquants vs défenseurs<sup>(3)</sup></span
              >
              <span class="score">{{
                getFormattedScore(
                  currentEvaluation()?.attackersVsDefenders || 0
                )
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.kingExposedInCenter || 0)
              "
            >
              <span class="indicator-title"
                >Roi exposé au centre<sup>(1)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.kingExposedInCenter || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.openLinesAgainstKing || 0)
              "
            >
              <span class="indicator-title"
                >Lignes ouvertes vers le roi<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(
                  currentEvaluation()?.openLinesAgainstKing || 0
                )
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.kingCastlingSafety || 0)
              "
            >
              <span class="indicator-title"
                >Sécurité du roque<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.kingCastlingSafety || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.kingEscapeSquares || 0)
              "
            >
              <span class="indicator-title"
                >Cases de fuite du roi<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.kingEscapeSquares || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(kingPawnShieldScore())"
            >
              <span class="indicator-title"
                >Pions de protection du roi<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(kingPawnShieldScore())
              }}</span>
            </div>
          </div>
        </div>

        <!-- Rapport matériel -->
        <div class="analysis-section">
          <h3
            (click)="toggleSection('material')"
            [class.expanded]="isSectionExpanded('material')"
          >
            Rapport matériel
            <span class="expand-icon">{{
              isSectionExpanded("material") ? "▼" : "▶"
            }}</span>
          </h3>
          <div
            class="indicator-list"
            [class.expanded]="isSectionExpanded('material')"
          >
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.materialAdvantage || 0)
              "
            >
              <span class="indicator-title"
                >Avantage matériel<sup>(1)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.materialAdvantage || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.exchangeQuality || 0)"
            >
              <span class="indicator-title"
                >Qualité d'échange<sup>(1)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.exchangeQuality || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.bishopPair || 0)"
            >
              <span class="indicator-title">Paire de fou<sup>(1)</sup></span>
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.bishopPair || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.queenVsMinorPieces || 0)
              "
            >
              <span class="indicator-title"
                >Dame vs pièces mineures<sup>(1)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.queenVsMinorPieces || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.rookVsMinorPieces || 0)
              "
            >
              <span class="indicator-title"
                >Tour vs pièces mineures<sup>(1)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.rookVsMinorPieces || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.lightSquareAdvantage || 0)
              "
            >
              <span class="indicator-title"
                >Avantage sur cases blanches<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(
                  currentEvaluation()?.lightSquareAdvantage || 0
                )
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.darkSquareAdvantage || 0)
              "
            >
              <span class="indicator-title"
                >Avantage sur cases noires<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.darkSquareAdvantage || 0)
              }}</span>
            </div>
          </div>
        </div>

        <!-- Activité des pièces -->
        <div class="analysis-section">
          <h3
            (click)="toggleSection('pieceActivity')"
            [class.expanded]="isSectionExpanded('pieceActivity')"
          >
            Activité des pièces
            <span class="expand-icon">{{
              isSectionExpanded("pieceActivity") ? "▼" : "▶"
            }}</span>
          </h3>
          <div
            class="indicator-list"
            [class.expanded]="isSectionExpanded('pieceActivity')"
          >
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.activePieces || 0)"
            >
              <span class="indicator-title"
                >Pièces actives vs passives<sup>(3)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.activePieces || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.pieceMobility || 0)"
            >
              <span class="indicator-title"
                >Mobilité des pièces<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.pieceMobility || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.pieceCoordination || 0)
              "
            >
              <span class="indicator-title"
                >Coordination des pièces<sup>(3)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.pieceCoordination || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.rookColumnControl || 0)
              "
            >
              <span class="indicator-title"
                >Contrôle de colonne par la tour<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.rookColumnControl || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.overloadedPieces || 0)
              "
            >
              <span class="indicator-title"
                >Pièces surchargées<sup>(3)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.overloadedPieces || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.badlyPlacedPieces || 0)
              "
            >
              <span class="indicator-title"
                >Pièces mal placées<sup>(3)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.badlyPlacedPieces || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.bishopVsKnight || 0)"
            >
              <span class="indicator-title"
                >Fou contre cavalier<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.bishopVsKnight || 0)
              }}</span>
            </div>
          </div>
        </div>

        <!-- Prise d'espace -->
        <div class="analysis-section">
          <h3
            (click)="toggleSection('spaceControl')"
            [class.expanded]="isSectionExpanded('spaceControl')"
          >
            Prise d'espace
            <span class="expand-icon">{{
              isSectionExpanded("spaceControl") ? "▼" : "▶"
            }}</span>
          </h3>
          <div
            class="indicator-list"
            [class.expanded]="isSectionExpanded('spaceControl')"
          >
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.centerControl || 0)"
            >
              <span class="indicator-title"
                >Contrôle du centre<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.centerControl || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.spaceAdvantage || 0)"
            >
              <span class="indicator-title"
                >Avantage d'espace<sup>(3)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.spaceAdvantage || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.weakSquares || 0)"
            >
              <span class="indicator-title">Cases faibles<sup>(3)</sup></span>
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.weakSquares || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.outposts || 0)"
            >
              <span class="indicator-title">Avant-postes<sup>(2)</sup></span>
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.outposts || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.holes || 0)"
            >
              <span class="indicator-title"
                >Trous dans la position<sup>(3)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.holes || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.centerTension || 0)"
            >
              <span class="indicator-title"
                >Tension au centre<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.centerTension || 0)
              }}</span>
            </div>
          </div>
        </div>

        <!-- Structure de pions -->
        <div class="analysis-section">
          <h3
            (click)="toggleSection('pawnStructure')"
            [class.expanded]="isSectionExpanded('pawnStructure')"
          >
            Structure de pions
            <span class="expand-icon">{{
              isSectionExpanded("pawnStructure") ? "▼" : "▶"
            }}</span>
          </h3>
          <div
            class="indicator-list"
            [class.expanded]="isSectionExpanded('pawnStructure')"
          >
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.passedPawns || 0)"
            >
              <span class="indicator-title">Pion passé<sup>(2)</sup></span>
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.passedPawns || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.protectedPassedPawns || 0)
              "
            >
              <span class="indicator-title"
                >Pion passé protégé<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(
                  currentEvaluation()?.protectedPassedPawns || 0
                )
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.distantPassedPawns || 0)
              "
            >
              <span class="indicator-title"
                >Pion passé éloigné<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.distantPassedPawns || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.isolatedPawns || 0)"
            >
              <span class="indicator-title">Pions isolés<sup>(1)</sup></span>
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.isolatedPawns || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.backwardPawns || 0)"
            >
              <span class="indicator-title">Pion arrièré<sup>(2)</sup></span>
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.backwardPawns || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="
                getScoreClass(currentEvaluation()?.backwardPawnsOnSemiOpen || 0)
              "
            >
              <span class="indicator-title"
                >Pion arrière sur colonne semi-ouverte<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(
                  currentEvaluation()?.backwardPawnsOnSemiOpen || 0
                )
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.pawnMajority || 0)"
            >
              <span class="indicator-title"
                >Majorité de pions<sup>(1)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.pawnMajority || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.doubledPawns || 0)"
            >
              <span class="indicator-title">Pions doublés<sup>(1)</sup></span>
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.doubledPawns || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.pawnIslands || 0)"
            >
              <span class="indicator-title"
                >Nb d'îlots de pions<sup>(2)</sup></span
              >
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.pawnIslands || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.hangingPawns || 0)"
            >
              <span class="indicator-title">Pions pendants<sup>(2)</sup></span>
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.hangingPawns || 0)
              }}</span>
            </div>
            <div
              class="indicator-item"
              [class]="getScoreClass(currentEvaluation()?.pawnChains || 0)"
            >
              <span class="indicator-title">Chaîne de pions<sup>(2)</sup></span>
              <span class="score">{{
                getFormattedScore(currentEvaluation()?.pawnChains || 0)
              }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Section échiquier au centre -->
  <div class="board-section">
    <app-chess-board-with-controls
      #chessBoardWithControls
      [position]="currentPosition"
      [disableClicks]="!isFreeMoveEnabled()"
      [showNavigationControls]="true"
      [canGoBack]="canGoBack"
      [canGoForward]="canGoForward"
      (positionChange)="onPositionChange($event)"
      (moveChange)="onMoveChange($event)"
      (goToStart)="goToStart()"
      (goToPrevious)="goToPrevious()"
      (goToNext)="goToNext()"
      (goToEnd)="goToEnd()"
    ></app-chess-board-with-controls>
  </div>

  <!-- Panneau vertical côté droit -->
  <div class="side-panel">
    <div class="panel-content">
      <!-- Corps principal de la sidebar -->
      <div class="sidebar-body">
        <!-- Sélecteur de mode d'analyse -->
        <div class="mode-selector-card">
          <h3>Analysis Mode</h3>
          <div class="mode-buttons">
            <button
              class="mode-btn"
              [class.active]="isFreeMoveEnabled()"
              (click)="setAnalysisMode('free')"
            >
              Free Mode
            </button>
            <button
              class="mode-btn"
              [class.active]="isPgnMode()"
              (click)="setAnalysisMode('pgn')"
            >
              PGN Mode
            </button>
          </div>
        </div>

        <!-- Zone de chargement PGN (mode PGN seulement) -->
        @if (isPgnMode() && !isNavigationMode()) {
        <div class="pgn-input-card">
          <h3>Load a Game</h3>
          <textarea
            [(ngModel)]="pgnText"
            placeholder="Paste your PGN here..."
            class="pgn-textarea-compact"
            rows="4"
          ></textarea>
          <button (click)="loadPgn()" class="load-btn-compact">Load</button>
        </div>
        }

        <!-- Contenu spécifique au mode libre -->
        @if (isFreeMoveEnabled()) {
        <div class="free-mode-content">
          <!-- Statut de la partie -->
          <div class="game-status-card">
            <h3>Game Status</h3>
            <h2 [class.checkmate]="isGameOver" [class.check]="isCheck">
              {{ gameStatus }}
            </h2>
            <button (click)="resetGame()" class="reset-btn">New Game</button>
          </div>

          <!-- Informations du mode libre -->
          <div class="game-info-card">
            <h3>Information</h3>
            <div class="info-item">
              <span class="label">Mode</span>
              <span class="value">Free Play</span>
            </div>
            <div class="info-item">
              <span class="label">Type</span>
              <span class="value">Position Analysis</span>
            </div>
          </div>
        </div>
        }

        <!-- Contenu spécifique au mode PGN -->
        @if (isPgnMode() && isNavigationMode()) {
        <div class="pgn-mode-content">
          <!-- Navigation et statut -->
          <div class="navigation-card">
            <h3>Game Navigation</h3>
            <div class="move-info">
              {{ getCurrentMoveDisplay() }}
            </div>
            <!-- Les boutons de navigation sont maintenant sous l'échiquier -->
          </div>

          <!-- Informations sur l'analyse PGN -->
          <div class="analyze-info-card">
            <h3>Analysis Information</h3>
            <div class="info-item">
              <span class="label">Mode</span>
              <span class="value">PGN Analysis</span>
            </div>
            <div class="info-item">
              <span class="label">Position</span>
              <span class="value">{{ getCurrentMoveDisplay() }}</span>
            </div>
            <div class="info-item">
              <span class="label">Navigation</span>
              <span class="value">{{ canGoBack ? "Active" : "Start" }}</span>
            </div>
            <button (click)="newPgnAnalysis()" class="back-home-btn">
              New PGN Analysis
            </button>
          </div>
        </div>
        }
      </div>

      <!-- Pied de sidebar - le toggle experimental a été déplacé sous l'échiquier -->
      <div class="sidebar-footer">
        <!-- Plus de toggle experimental ici, il est maintenant sous l'échiquier -->
      </div>
    </div>
  </div>
</div>
