<div class="layout-with-sidebar">
  <!-- Section √©chiquier √† gauche -->
  <div class="board-section">
    <!-- √âtat non connect√© -->
    <div *ngIf="!(user$ | async)" class="auth-required">
      <div class="auth-message">
        <h1>Connexion requise</h1>
        <p>Connectez-vous avec votre compte Google pour jouer en multijoueur</p>
        <button class="btn-google" (click)="signInWithGoogle()">
          Se connecter avec Google
        </button>
      </div>
    </div>

    <!-- √âchiquier pour utilisateur connect√© -->
    <div *ngIf="user$ | async" class="game-board">
      <!-- √âchiquier avec background dynamique -->
      <app-board-wrapper [backgroundColor]="getBoardBackgroundColor()">
        <!-- Background classique -->
        @if (selectedBackground() === 'classic') {
        <app-classic-board
          [position]="currentPosition()"
          [orientation]="getBoardOrientation()"
        ></app-classic-board>
        }

        <!-- Background heatmap -->
        @if (selectedBackground() === 'heatmap') {
        <app-heatmap-board
          [position]="currentPosition()"
          [orientation]="getBoardOrientation()"
        ></app-heatmap-board>
        }

        <!-- Background topographique -->
        @if (selectedBackground() === 'topographic') {
        <app-topographic-board
          [position]="currentPosition()"
          [orientation]="getBoardOrientation()"
        ></app-topographic-board>
        }

        <!-- Grille de pi√®ces par-dessus -->
        <app-echiquier
          [externalPosition]="currentPosition()"
          [disableClicks]="!isPlayerTurn() || isGameFinished()"
          [isMultiplayer]="true"
          [orientation]="getBoardOrientation()"
          (moveChange)="onMoveChange($event)"
        ></app-echiquier>
      </app-board-wrapper>
    </div>
  </div>

  <!-- Panneau vertical c√¥t√© droit -->
  <div class="side-panel" *ngIf="user$ | async">
    <div class="panel-content">
      <!-- Partie en cours -->
      @if (currentGame) {
      <div class="current-game-card">
        <h3>Partie en cours</h3>

        <!-- Informations des joueurs -->
        <div class="players-info">
          <!-- Adversaire -->
          <div class="player-card" *ngIf="getOpponentInfo() as opponent">
            <img
              [src]="opponent.photoURL || '/assets/default-avatar.png'"
              [alt]="opponent.displayName"
              class="player-avatar"
            />
            <div class="player-details">
              <h4>{{ opponent.displayName }}</h4>
              <div class="player-color">
                <span class="color-indicator" [class]="opponent.color"></span>
                {{ opponent.color === "white" ? "Blancs" : "Noirs" }}
              </div>
            </div>
          </div>

          <!-- Joueur actuel -->
          <div
            class="player-card current"
            *ngIf="getCurrentPlayerInfo() as player"
          >
            <img
              [src]="
                authService.getCurrentUser()?.photoURL ||
                '/assets/default-avatar.png'
              "
              [alt]="player.displayName"
              class="player-avatar"
            />
            <div class="player-details">
              <h4>{{ player.displayName }} (Vous)</h4>
              <div class="player-color">
                <span class="color-indicator" [class]="player.color"></span>
                {{ player.color === "white" ? "Blancs" : "Noirs" }}
              </div>
            </div>
          </div>
        </div>

        <!-- Statut de la partie -->
        <div class="game-status">
          <h4
            [class.your-turn]="isPlayerTurn()"
            [class.finished]="isGameFinished()"
          >
            {{ getGameStatus() }}
          </h4>

          <!-- Compteur de redirection -->
          <div class="redirect-countdown" *ngIf="redirectCountdown > 0">
            <p>Retour au lobby dans {{ redirectCountdown }}s</p>
            <div class="countdown-bar">
              <div
                class="countdown-progress"
                [style.width.%]="(5 - redirectCountdown) * 20"
              ></div>
            </div>
            <button class="cancel-btn" (click)="cancelRedirect()">
              Rester
            </button>
          </div>

          <!-- Boutons de partie -->
          <div class="game-actions">
            <button
              class="resign-btn"
              (click)="resignGame()"
              [disabled]="isGameFinished() || isResigning"
              *ngIf="!isGameFinished()"
            >
              {{ isResigning ? "..." : "Abandonner" }}
            </button>

            <button
              class="back-lobby-btn"
              (click)="backToLobby()"
              *ngIf="isGameFinished()"
            >
              Retour au lobby
            </button>
          </div>
        </div>
      </div>
      } @else {

      <!-- D√©fis re√ßus -->
      @if (challenges.length > 0) {
      <div class="challenges-card">
        <h3>D√©fis re√ßus</h3>
        <div class="challenges-list">
          <div *ngFor="let challenge of challenges" class="challenge-item">
            <div class="challenger-info">
              <img
                *ngIf="challenge.from.photoURL"
                [src]="challenge.from.photoURL"
                class="challenger-avatar"
              />
              <div class="challenger-details">
                <h4>{{ challenge.from.displayName }}</h4>
                <p>vous d√©fie</p>
              </div>
            </div>
            <div class="challenge-actions">
              <button class="accept-btn" (click)="acceptChallenge(challenge)">
                Accepter
              </button>
              <button class="decline-btn" (click)="declineChallenge(challenge)">
                Refuser
              </button>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- Partie rapide -->
      <div class="quick-match-card">
        <h3>Partie rapide</h3>
        <button
          class="quick-match-btn"
          (click)="quickMatch()"
          [disabled]="isQuickMatching || onlinePlayers.length === 0"
        >
          <span *ngIf="!isQuickMatching">‚ö° Partie Rapide</span>
          <span *ngIf="isQuickMatching">üîç Recherche...</span>
        </button>
        <p class="hint" *ngIf="onlinePlayers.length === 0">
          Aucun joueur disponible
        </p>
      </div>

      <!-- Joueurs en ligne -->
      <div class="players-card">
        <h3>Joueurs disponibles ({{ onlinePlayers.length }})</h3>

        <div *ngIf="onlinePlayers.length === 0" class="no-players">
          <p>Aucun joueur connect√©</p>
        </div>

        <div class="players-list">
          <div
            *ngFor="let player of onlinePlayers"
            class="player-item"
            [class.disabled]="player.status !== 'available'"
          >
            <div class="player-info">
              <img
                *ngIf="player.photoURL"
                [src]="player.photoURL"
                class="player-avatar"
              />
              <div class="player-details">
                <h4>{{ player.displayName }}</h4>
                <div class="player-status">
                  <span
                    class="status-dot"
                    [style.background-color]="getStatusColor(player.status)"
                  ></span>
                  <span class="status-text">{{
                    getStatusLabel(player.status)
                  }}</span>
                </div>
              </div>
            </div>

            <div class="player-actions">
              <button
                class="challenge-btn"
                (click)="challengePlayer(player)"
                [disabled]="
                  player.status !== 'available' ||
                  challengingPlayer === player.uid
                "
              >
                <span *ngIf="challengingPlayer !== player.uid">D√©fier</span>
                <span *ngIf="challengingPlayer === player.uid">Envoi...</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      }

      <!-- S√©lecteur de type d'affichage -->
      <div class="background-selector-vertical">
        <h3>Type d'affichage</h3>
        <div class="bg-buttons">
          <button
            class="bg-btn-vertical"
            [class.active]="selectedBackground() === 'classic'"
            (click)="setBackground('classic')"
          >
            Classique
          </button>
          <button
            class="bg-btn-vertical"
            [class.active]="selectedBackground() === 'heatmap'"
            (click)="setBackground('heatmap')"
          >
            Territorial
          </button>
          <button
            class="bg-btn-vertical"
            [class.active]="selectedBackground() === 'topographic'"
            (click)="setBackground('topographic')"
          >
            Topographique
          </button>
        </div>
      </div>

      <!-- Contr√¥le de luminosit√© -->
      <div class="brightness-control">
        <h3>Luminosit√© de l'√©chiquier</h3>
        <div class="brightness-slider-container">
          <div class="brightness-labels">
            <span class="brightness-value">{{ brightness() }}%</span>
          </div>
          <input
            type="range"
            min="0"
            max="100"
            [value]="brightness()"
            (input)="setBrightness($any($event.target).value)"
            class="brightness-slider"
          />
        </div>
      </div>
    </div>
  </div>
</div>
