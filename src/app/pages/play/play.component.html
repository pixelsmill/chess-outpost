<div class="layout-with-sidebar">
  <!-- Section Ã©chiquier Ã  gauche -->
  <div class="board-section" #boardSection>
    <!-- Ã‰chiquier toujours visible -->
    <div class="game-board">
      <!-- Ã‰chiquier avec background dynamique -->
      <app-board-wrapper
        [backgroundColor]="boardDisplay.getBoardBackgroundColor()"
        [style.transform]="'scale(' + boardDisplay.boardScale() + ')'"
        [style.transform-origin]="'center'"
        [style.transition]="'transform 0.3s ease'"
      >
        <!-- Background heatmap -->
        @if (boardDisplay.selectedBackground() === 'heatmap') {
        <app-heatmap-board
          [position]="currentPosition()"
          [orientation]="getBoardOrientation()"
        ></app-heatmap-board>
        }

        <!-- Background topographique -->
        @if (boardDisplay.selectedBackground() === 'topographic') {
        <app-topographic-board
          [position]="currentPosition()"
          [orientation]="getBoardOrientation()"
        ></app-topographic-board>
        }

        <!-- Grille de piÃ¨ces par-dessus -->
        <app-echiquier
          [externalPosition]="currentPosition()"
          [disableClicks]="
            !(user$ | async) || !isPlayerTurn() || isGameFinished()
          "
          [isMultiplayer]="true"
          [orientation]="getBoardOrientation()"
          (moveChange)="onMoveChange($event)"
        ></app-echiquier>
      </app-board-wrapper>
    </div>
  </div>

  <!-- Panneau vertical cÃ´tÃ© droit -->
  <div class="side-panel">
    <div class="panel-content">
      <!-- Corps principal de la sidebar -->
      <div class="sidebar-body">
        <!-- Panel utilisateur connectÃ© ou connexion -->
        @if (!(user$ | async)) {
        <div class="auth-card">
          <h3>Login Required</h3>
          <div class="login-message">
            Sign in with your Google account to play multiplayer
          </div>
          <button class="google-login-btn" (click)="signInWithGoogle()">
            Sign in with Google
          </button>
        </div>
        } @else {
        <div class="user-card">
          <h3>Logged in Player</h3>
          <div class="user-info">
            <img
              [src]="
                authService.getCurrentUser()?.photoURL ||
                '/assets/default-avatar.png'
              "
              [alt]="authService.getCurrentUser()?.displayName || 'User'"
              class="user-avatar"
            />
            <div class="user-details">
              <h4>{{ authService.getCurrentUser()?.displayName || "User" }}</h4>
              <p class="user-email">
                {{ authService.getCurrentUser()?.email }}
              </p>
            </div>
          </div>
          <button class="logout-btn" (click)="authService.logout()">
            Sign Out
          </button>
        </div>
        }

        <!-- Partie en cours -->
        @if (currentGame) {
        <div class="current-game-card">
          <h3>Current Game</h3>

          <!-- Informations des joueurs -->
          <div class="players-info">
            <!-- Adversaire -->
            <div class="player-card" *ngIf="getOpponentInfo() as opponent">
              <img
                [src]="opponent.photoURL || '/assets/default-avatar.png'"
                [alt]="opponent.displayName"
                class="player-avatar"
              />
              <div class="player-details">
                <h4>{{ opponent.displayName }}</h4>
                <div class="player-color">
                  <span class="color-indicator" [class]="opponent.color"></span>
                  {{ opponent.color === "white" ? "White" : "Black" }}
                </div>
              </div>
            </div>

            <!-- Joueur actuel -->
            <div
              class="player-card current"
              *ngIf="getCurrentPlayerInfo() as player"
            >
              <img
                [src]="
                  authService.getCurrentUser()?.photoURL ||
                  '/assets/default-avatar.png'
                "
                [alt]="player.displayName"
                class="player-avatar"
              />
              <div class="player-details">
                <h4>{{ player.displayName }} (You)</h4>
                <div class="player-color">
                  <span class="color-indicator" [class]="player.color"></span>
                  {{ player.color === "white" ? "White" : "Black" }}
                </div>
              </div>
            </div>
          </div>

          <!-- Statut de la partie -->
          <div class="game-status">
            <h4
              [class.your-turn]="isPlayerTurn()"
              [class.finished]="isGameFinished()"
            >
              {{ getGameStatus() }}
            </h4>

            <!-- Compteur de redirection -->
            <div class="redirect-countdown" *ngIf="redirectCountdown > 0">
              <p>Returning to lobby in {{ redirectCountdown }}s</p>
              <div class="countdown-bar">
                <div
                  class="countdown-progress"
                  [style.width.%]="(5 - redirectCountdown) * 20"
                ></div>
              </div>
              <button class="cancel-btn" (click)="cancelRedirect()">
                Stay
              </button>
            </div>

            <!-- Boutons de partie -->
            <div class="game-actions">
              <button
                class="resign-btn"
                (click)="resignGame()"
                [disabled]="isGameFinished() || isResigning"
                *ngIf="!isGameFinished()"
              >
                {{ isResigning ? "..." : "Resign" }}
              </button>

              <button
                class="back-lobby-btn"
                (click)="backToLobby()"
                *ngIf="isGameFinished()"
              >
                Back to Lobby
              </button>

              <!-- Bouton de debug temporaire -->
              <button
                class="debug-btn"
                (click)="logGameState()"
                style="
                  background: #666;
                  border: 1px solid #888;
                  color: white;
                  padding: 0.5rem;
                  margin-top: 0.5rem;
                  font-size: 0.8rem;
                  width: 100%;
                "
              >
                Debug State
              </button>

              <!-- Bouton pour forcer la rÃ©initialisation -->
              <button
                class="reload-btn"
                (click)="forceReloadListeners()"
                style="
                  background: #f59e0b;
                  border: 1px solid #d97706;
                  color: white;
                  padding: 0.5rem;
                  margin-top: 0.5rem;
                  font-size: 0.8rem;
                  width: 100%;
                "
              >
                ðŸ”„ Reload Listeners
              </button>
            </div>
          </div>
        </div>
        } @else {

        <!-- DÃ©fis reÃ§us -->
        @if (challenges.length > 0) {
        <div class="challenges-card">
          <h3>Received Challenges</h3>
          <div class="challenges-list">
            <div *ngFor="let challenge of challenges" class="challenge-item">
              <div class="challenger-info">
                <img
                  *ngIf="challenge.from.photoURL"
                  [src]="challenge.from.photoURL"
                  class="challenger-avatar"
                />
                <div class="challenger-details">
                  <h4>{{ challenge.from.displayName }}</h4>
                  <p>challenges you</p>
                </div>
              </div>
              <div class="challenge-actions">
                <button class="accept-btn" (click)="acceptChallenge(challenge)">
                  Accept
                </button>
                <button
                  class="decline-btn"
                  (click)="declineChallenge(challenge)"
                >
                  Decline
                </button>
              </div>
            </div>
          </div>
        </div>
        }

        <!-- Partie rapide -->
        <div class="quick-match-card">
          <h3>Quick Match</h3>
          <button
            class="quick-match-btn"
            (click)="quickMatch()"
            [disabled]="isQuickMatching || onlinePlayers.length === 0"
          >
            <span *ngIf="!isQuickMatching">Quick Match</span>
            <span *ngIf="isQuickMatching">Searching...</span>
          </button>
          <p class="hint" *ngIf="onlinePlayers.length === 0">
            No players available
          </p>
        </div>

        <!-- Joueurs en ligne -->
        <div class="players-card">
          <h3>Available Players ({{ onlinePlayers.length }})</h3>

          <div *ngIf="onlinePlayers.length === 0" class="no-players">
            <p>No players online</p>
          </div>

          <div class="players-list">
            <div
              *ngFor="let player of onlinePlayers"
              class="player-item"
              [class.disabled]="player.status !== 'available'"
            >
              <div class="player-info">
                <img
                  *ngIf="player.photoURL"
                  [src]="player.photoURL"
                  class="player-avatar"
                />
                <div class="player-details">
                  <h4>{{ player.displayName }}</h4>
                  <div class="player-status">
                    <span class="status-text">{{
                      getStatusLabel(player.status)
                    }}</span>
                  </div>
                </div>
              </div>

              <div class="player-actions">
                <button
                  class="challenge-btn"
                  (click)="challengePlayer(player)"
                  [disabled]="
                    player.status !== 'available' ||
                    challengingPlayer === player.uid
                  "
                >
                  <span *ngIf="challengingPlayer !== player.uid"
                    >Challenge</span
                  >
                  <span *ngIf="challengingPlayer === player.uid"
                    >Sending...</span
                  >
                </button>
              </div>
            </div>
          </div>
        </div>

        }
      </div>

      <!-- Pied de sidebar -->
      <div class="sidebar-footer">
        <!-- Toggle experimental en pied de sidebar -->
        <div class="experimental-toggle">
          <div class="toggle-container">
            <label class="toggle-switch">
              <input
                type="checkbox"
                [checked]="boardDisplay.selectedBackground() === 'topographic'"
                (change)="boardDisplay.toggleExperimentalMode($event)"
              />
              <span class="slider"></span>
            </label>
            <span class="toggle-label">Experimental</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
