<div class="layout-with-sidebar">
  <!-- Section échiquier à gauche -->
  <div class="board-section">
    <!-- Échiquier toujours visible -->
    <div class="game-board">
      <!-- Échiquier avec background dynamique -->
      <app-board-wrapper [backgroundColor]="getBoardBackgroundColor()">
        <!-- Background heatmap -->
        @if (selectedBackground() === 'heatmap') {
        <app-heatmap-board
          [position]="currentPosition()"
          [orientation]="getBoardOrientation()"
        ></app-heatmap-board>
        }

        <!-- Background topographique -->
        @if (selectedBackground() === 'topographic') {
        <app-topographic-board
          [position]="currentPosition()"
          [orientation]="getBoardOrientation()"
        ></app-topographic-board>
        }

        <!-- Grille de pièces par-dessus -->
        <app-echiquier
          [externalPosition]="currentPosition()"
          [disableClicks]="
            !(user$ | async) || !isPlayerTurn() || isGameFinished()
          "
          [isMultiplayer]="true"
          [orientation]="getBoardOrientation()"
          (moveChange)="onMoveChange($event)"
        ></app-echiquier>
      </app-board-wrapper>
    </div>
  </div>

  <!-- Panneau vertical côté droit -->
  <div class="side-panel">
    <div class="panel-content">
      <!-- Panel de connexion si utilisateur non connecté -->
      @if (!(user$ | async)) {
      <div class="auth-card">
        <h3>Connexion requise</h3>
        <div class="login-message">
          Connectez-vous avec votre compte Google pour jouer en multijoueur
        </div>
        <button class="google-login-btn" (click)="signInWithGoogle()">
          Se connecter avec Google
        </button>
      </div>
      } @else {

      <!-- Contenu pour utilisateur connecté -->

      <!-- Partie en cours -->
      @if (currentGame) {
      <div class="current-game-card">
        <h3>Partie en cours</h3>

        <!-- Informations des joueurs -->
        <div class="players-info">
          <!-- Adversaire -->
          <div class="player-card" *ngIf="getOpponentInfo() as opponent">
            <img
              [src]="opponent.photoURL || '/assets/default-avatar.png'"
              [alt]="opponent.displayName"
              class="player-avatar"
            />
            <div class="player-details">
              <h4>{{ opponent.displayName }}</h4>
              <div class="player-color">
                <span class="color-indicator" [class]="opponent.color"></span>
                {{ opponent.color === "white" ? "Blancs" : "Noirs" }}
              </div>
            </div>
          </div>

          <!-- Joueur actuel -->
          <div
            class="player-card current"
            *ngIf="getCurrentPlayerInfo() as player"
          >
            <img
              [src]="
                authService.getCurrentUser()?.photoURL ||
                '/assets/default-avatar.png'
              "
              [alt]="player.displayName"
              class="player-avatar"
            />
            <div class="player-details">
              <h4>{{ player.displayName }} (Vous)</h4>
              <div class="player-color">
                <span class="color-indicator" [class]="player.color"></span>
                {{ player.color === "white" ? "Blancs" : "Noirs" }}
              </div>
            </div>
          </div>
        </div>

        <!-- Statut de la partie -->
        <div class="game-status">
          <h4
            [class.your-turn]="isPlayerTurn()"
            [class.finished]="isGameFinished()"
          >
            {{ getGameStatus() }}
          </h4>

          <!-- Compteur de redirection -->
          <div class="redirect-countdown" *ngIf="redirectCountdown > 0">
            <p>Retour au lobby dans {{ redirectCountdown }}s</p>
            <div class="countdown-bar">
              <div
                class="countdown-progress"
                [style.width.%]="(5 - redirectCountdown) * 20"
              ></div>
            </div>
            <button class="cancel-btn" (click)="cancelRedirect()">
              Rester
            </button>
          </div>

          <!-- Boutons de partie -->
          <div class="game-actions">
            <button
              class="resign-btn"
              (click)="resignGame()"
              [disabled]="isGameFinished() || isResigning"
              *ngIf="!isGameFinished()"
            >
              {{ isResigning ? "..." : "Abandonner" }}
            </button>

            <button
              class="back-lobby-btn"
              (click)="backToLobby()"
              *ngIf="isGameFinished()"
            >
              Retour au lobby
            </button>
          </div>
        </div>
      </div>
      } @else {

      <!-- Défis reçus -->
      @if (challenges.length > 0) {
      <div class="challenges-card">
        <h3>Défis reçus</h3>
        <div class="challenges-list">
          <div *ngFor="let challenge of challenges" class="challenge-item">
            <div class="challenger-info">
              <img
                *ngIf="challenge.from.photoURL"
                [src]="challenge.from.photoURL"
                class="challenger-avatar"
              />
              <div class="challenger-details">
                <h4>{{ challenge.from.displayName }}</h4>
                <p>vous défie</p>
              </div>
            </div>
            <div class="challenge-actions">
              <button class="accept-btn" (click)="acceptChallenge(challenge)">
                Accepter
              </button>
              <button class="decline-btn" (click)="declineChallenge(challenge)">
                Refuser
              </button>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- Partie rapide -->
      <div class="quick-match-card">
        <h3>Partie rapide</h3>
        <button
          class="quick-match-btn"
          (click)="quickMatch()"
          [disabled]="isQuickMatching || onlinePlayers.length === 0"
        >
          <span *ngIf="!isQuickMatching">Partie Rapide</span>
          <span *ngIf="isQuickMatching">Recherche...</span>
        </button>
        <p class="hint" *ngIf="onlinePlayers.length === 0">
          Aucun joueur disponible
        </p>
      </div>

      <!-- Joueurs en ligne -->
      <div class="players-card">
        <h3>Joueurs disponibles ({{ onlinePlayers.length }})</h3>

        <div *ngIf="onlinePlayers.length === 0" class="no-players">
          <p>Aucun joueur connecté</p>
        </div>

        <div class="players-list">
          <div
            *ngFor="let player of onlinePlayers"
            class="player-item"
            [class.disabled]="player.status !== 'available'"
          >
            <div class="player-info">
              <img
                *ngIf="player.photoURL"
                [src]="player.photoURL"
                class="player-avatar"
              />
              <div class="player-details">
                <h4>{{ player.displayName }}</h4>
                <div class="player-status">
                  <span class="status-text">{{
                    getStatusLabel(player.status)
                  }}</span>
                </div>
              </div>
            </div>

            <div class="player-actions">
              <button
                class="challenge-btn"
                (click)="challengePlayer(player)"
                [disabled]="
                  player.status !== 'available' ||
                  challengingPlayer === player.uid
                "
              >
                <span *ngIf="challengingPlayer !== player.uid">Défier</span>
                <span *ngIf="challengingPlayer === player.uid">Envoi...</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      } }

      <!-- Toggle experimental -->
      <div class="experimental-toggle">
        <h3>Mode d'affichage</h3>
        <div class="toggle-container">
          <label class="toggle-switch">
            <input
              type="checkbox"
              [checked]="selectedBackground() === 'topographic'"
              (change)="toggleExperimentalMode($event)"
            />
            <span class="slider"></span>
          </label>
          <span class="toggle-label">Experimental</span>
        </div>
      </div>
    </div>
  </div>
</div>
